{% extends 'base.html' %}

{% block title %}
    FlameDate
{% endblock %}

{% block content %}
<div class="swipes-page d-flex">
  <!-- Sidebar -->
  <div class="sidebar d-flex flex-column p-3 text-white">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <a href="{{ url_for('perfil') }}">
        <img src="{% if user.images.count() > 0 %}{{ url_for('static', filename=user.images.order_by('uploaded_at').first().filename) }}{% else %}{{ url_for('static', filename='images/perfil.jpg') }}{% endif %}" class="profile-thumb rounded-circle" alt="Perfil"/>
      </a>
      <img src="{{ url_for('static', filename='images/config.svg') }}" alt="Configurar" class="config-icon" id="toggleConfig"/>
    </div>

    <!-- Línea separadora -->
    <div class="sidebar-divider mb-3"></div>

    <div class="tabs d-flex w-100 mb-3" id="tabs">
      <a href="#" class="text-white text-decoration-none active-tab tab-item text-center">FLAMES</a>
      <a href="{{ url_for('chats') }}" class="text-white text-decoration-none inactive-tab tab-item text-center">MENSAJES</a>
    </div>

    <!-- Configuración -->
    <div id="config-panel" class="config-panel d-none mt-3">
      <h3 class="config-title">RANGO DE BÚSQUEDA</h3>
      <!-- Distancia -->
      <div class="mb-3">
        <div class="w-100 text-start">
          <label for="distanceRange" class="form-label">Distancia: <span id="distanceValue">5 km</span></label>
        </div>
        <input type="range" id="distanceRange" class="styled-range" min="1" max="50" value="5" step="1" style="width:100%;">
      </div>
      <!-- Edad -->
      <div class="mb-3">
        <div class="w-100 text-start">
          <label for="minAge" class="form-label">Edad: <span id="ageValue">18 - 30</span></label>
        </div>
        <div class="range-slider position-relative d-flex align-items-center" id="ageSlider" style="gap:8px;">
          <input type="range" id="minAge" class="styled-range" min="18" max="70" value="18" step="1" style="width:100%;">
          <span class="mx-1">-</span>
          <input type="range" id="maxAge" class="styled-range" min="18" max="70" value="30" step="1" style="width:100%;">
        </div>
      </div>
    </div>

    <!-- Lista de flames -->
    <div class="flame-list grid-flames" id="flameList">
      {% for flame in flame_users %}
      <div class="flame-item text-center">
        <img src="{{ url_for('static', filename=flame.images.order_by('uploaded_at').first().filename) if flame.images.count() > 0 else url_for('static', filename='images/perfil.jpg') }}" class="flame-img rounded-circle" alt="{{ flame.username }}"/>
        <p class="flame-name mb-0">{{ flame.username }}, {{ flame.age }}</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Swiping Card -->
  <div class="main-content d-flex align-items-center justify-content-center flex-grow-1">
    {% for user in users %}
    <div class="profile-card position-relative mb-4 user-card" style="display: {{ 'block' if loop.first else 'none' }};" data-user-id="{{ user.id }}">
      <div class="image-carousel" data-user-id="{{ user.id }}">
        {% set images = user.images.order_by('uploaded_at').all() %}
        {% if images %}
          {% for img in images %}
            <img src="{{ url_for('static', filename=img.filename) }}" class="card-img{% if loop.first %} active{% endif %}" alt="Foto perfil" data-img-idx="{{ loop.index0 }}"/>
          {% endfor %}
        {% else %}
          <img src="{{ url_for('static', filename='images/perfil.jpg') }}" class="card-img active" alt="Foto perfil" data-img-idx="0"/>
        {% endif %}
        <div class="click-zone left-zone"></div>
        <div class="click-zone right-zone"></div>
        <div class="image-indicators">
          {% for img in images %}
            <div class="indicator{% if loop.first %} active{% endif %}" data-img-idx="{{ loop.index0 }}"></div>
          {% endfor %}
          {% if not images %}
            <div class="indicator active" data-img-idx="0"></div>
          {% endif %}
        </div>
      </div>
      <div class="card-info">
        <div class="d-flex justify-content-between w-100">
          <div>
            <h2 class="name-age mb-0">
              {{ user.username }}
              {% if user.age %}<span class="age">{{ user.age }}</span>{% endif %}
            </h2>
            <p class="distance mb-0">
              {% if user.sex_ori %}
                {{ user.sex_ori }}
              {% else %}
                Sin orientación especificada
              {% endif %}
            </p>
          </div>
          <div class="description text-end">{{ user.bio if user.bio else '✨ LO QUE SURJA' }}</div>
        </div>
        <div class="card-actions d-flex justify-content-center gap-4 mt-3">
          <button class="btn btn-light rounded-circle icon-btn nope-btn" aria-label="Nope">
            <img src="{{ url_for('static', filename='images/cross.svg') }}" alt="Nope" width="35"/>
          </button>
          <button class="btn btn-light rounded-circle icon-btn flame-btn" aria-label="Like">
            <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Like" width="35"/>
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const configIcon = document.getElementById("toggleConfig");
  const configPanel = document.getElementById("config-panel");
  const flameList = document.getElementById("flameList");
  const tabs = document.getElementById("tabs");

  let configVisible = false;

  configIcon?.addEventListener("click", () => {
    configVisible = !configVisible;
    configPanel?.classList.toggle("d-none", !configVisible);
    flameList?.classList.toggle("d-none", configVisible);
    tabs?.classList.toggle("d-none", configVisible);
  });

  // Sliders
  const distanceRange = document.getElementById("distanceRange");
  const distanceValue = document.getElementById("distanceValue");
  const minAgeSlider = document.getElementById("minAge");
  const maxAgeSlider = document.getElementById("maxAge");
  const ageValue = document.getElementById("ageValue");

  function updateSingleSliderBackground(input) {
    const val = parseInt(input.value);
    const min = parseInt(input.min);
    const max = parseInt(input.max);
    const percent = ((val - min) / (max - min)) * 100;
    input.style.background = `linear-gradient(to right, #ff4d4d 0%, #ff4d4d ${percent}%, rgba(255,255,255,0.2) ${percent}%)`;
  }

  function updateDualSliderBackground() {
    const min = parseInt(minAgeSlider.min);
    const max = parseInt(maxAgeSlider.max);
    const minVal = parseInt(minAgeSlider.value);
    const maxVal = parseInt(maxAgeSlider.value);

    const minPercent = ((minVal - min) / (max - min)) * 100;
    const maxPercent = ((maxVal - min) / (max - min)) * 100;

    const gradient = 
      `linear-gradient(to right,
        rgba(255,255,255,0.2) ${minPercent}%,
        #ff4d4d ${minPercent}%,
        #ff4d4d ${maxPercent}%,
        rgba(255,255,255,0.2) ${maxPercent}%)`;

    minAgeSlider.style.background = gradient;
    maxAgeSlider.style.background = gradient;
  }

  function updateDualSlider() {
    let minVal = parseInt(minAgeSlider.value);
    let maxVal = parseInt(maxAgeSlider.value);

    if (minVal > maxVal - 1) {
      minVal = maxVal - 1;
      minAgeSlider.value = minVal;
    }
    if (maxVal < minVal + 1) {
      maxVal = minVal + 1;
      maxAgeSlider.value = maxVal;
    }

    ageValue.textContent = `${minVal} - ${maxVal}`;
    updateDualSliderBackground();
  }

  distanceRange?.addEventListener("input", () => {
    distanceValue.textContent = `${distanceRange.value} km`;
    updateSingleSliderBackground(distanceRange);
  });

  minAgeSlider?.addEventListener("input", updateDualSlider);
  maxAgeSlider?.addEventListener("input", updateDualSlider);

  // Inicializar valores y backgrounds
  if (distanceRange) {
    distanceValue.textContent = `${distanceRange.value} km`;
    updateSingleSliderBackground(distanceRange);
  }
  if (minAgeSlider && maxAgeSlider) {
    updateDualSlider();
  }

  // Swiping logic
  const userCards = document.querySelectorAll('.user-card');
  let currentIndex = 0;
  function showCard(index) {
    userCards.forEach((card, i) => {
      card.style.display = (i === index) ? 'block' : 'none';
    });
  }
  userCards.forEach((card, i) => {
    // Nope button
    card.querySelector('.nope-btn').addEventListener('click', function() {
      if (currentIndex < userCards.length - 1) {
        currentIndex++;
        showCard(currentIndex);
      } else {
        card.style.display = 'none';
      }
    });
    // Like button
    card.querySelector('.flame-btn').addEventListener('click', function() {
      const likedUserId = card.getAttribute('data-user-id');
      fetch('/like', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ liked_user_id: likedUserId }),
      })
      .then(response => response.json())
      .then(data => {
        // Optionally show a message or handle errors
      });
      // Move to next card
      if (currentIndex < userCards.length - 1) {
        currentIndex++;
        showCard(currentIndex);
      } else {
        card.style.display = 'none';
      }
    });
  });

  // Imagenes de perfil: carrusel manual
  document.querySelectorAll('.image-carousel').forEach(function(carousel) {
    const imgs = carousel.querySelectorAll('.card-img');
    const indicators = carousel.querySelectorAll('.indicator');
    let idx = 0;
    if (imgs.length <= 1) return;

    function showImg(newIdx) {
      imgs.forEach((img, i) => {
        img.classList.toggle('active', i === newIdx);
      });
      indicators.forEach((ind, i) => {
        ind.classList.toggle('active', i === newIdx);
      });
      idx = newIdx;
    }

    carousel.querySelector('.left-zone').addEventListener('click', function() {
      if (imgs.length > 1) {
        let newIdx = (idx - 1 + imgs.length) % imgs.length;
        showImg(newIdx);
      }
    });
    carousel.querySelector('.right-zone').addEventListener('click', function() {
      if (imgs.length > 1) {
        let newIdx = (idx + 1) % imgs.length;
        showImg(newIdx);
      }
    });
    // También permite hacer clic en los indicadores
    indicators.forEach((ind, i) => {
      ind.addEventListener('click', function() {
        showImg(i);
      });
    });
  });
});
</script>
{# <script src="{{ url_for('static', filename='swipe.js') }}" defer></script> #}
{# <script src="{{ url_for('static', filename='config.js') }}" defer></script> #}
<!-- Scripts comentados porque no existen aún -->
{% endblock %}